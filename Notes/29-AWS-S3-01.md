# Replication

## Configuring the Replication:
- create a madireddyanil-replication bucket and use this for replication
  ![968](https://github.com/user-attachments/assets/0aed20e0-bc05-4e86-970b-49f766332307)
  ![969](https://github.com/user-attachments/assets/6c9e4b47-fc4f-4391-a768-32a81650d114)
  ![970](https://github.com/user-attachments/assets/80e4a512-2a52-46bb-aeb0-15bdeef1109b)
  
- create a madireddyanil bucket and use this for Source
  ![971](https://github.com/user-attachments/assets/c2141d6f-1060-4f2f-8939-5226b31fc8a1)
  ![972](https://github.com/user-attachments/assets/ae756c61-85ab-40e6-9369-902170fcdadb)
  ![973](https://github.com/user-attachments/assets/2784fd6e-bda3-4085-918b-495e85db6cdb)

- After creating two buckets
  ![974](https://github.com/user-attachments/assets/8a1b1a5f-a3b7-4133-ad04-8da9e1afbc96)

- Now in madireddyanil bucket under management
  ![975](https://github.com/user-attachments/assets/daa5acd6-45cc-423f-b382-55f471970668)

- Clcik on Replication rule button to create replication rule
  ![976](https://github.com/user-attachments/assets/42c09519-872d-46cf-8faa-af200cd08080)

- Fill in the details.
  
  ![977](https://github.com/user-attachments/assets/42b2d41b-c179-4923-97ed-8640059f47d1)
  ![978](https://github.com/user-attachments/assets/390b86be-986b-4f23-a8d5-6f7c4d4a82a2)
  ![979](https://github.com/user-attachments/assets/ba5bacb3-5867-4af4-8a3a-a4b45e6e2add)
  ![980](https://github.com/user-attachments/assets/7d8be115-9fba-47db-9ac3-75f564832f90)
  ![981](https://github.com/user-attachments/assets/cad72696-1d34-40a9-b9b0-3686d7afa1ac)
  ![982](https://github.com/user-attachments/assets/1c49dcfc-7cd4-4fca-bff1-929e61531b51)
  ![983](https://github.com/user-attachments/assets/ac6114c9-2ab1-4953-82a8-a4bf8b4b8aa9)
- Make sure the IAM roles which you select for replications should have below given in Roles > Trusted relationships
- make sure you add under services s3 and ec2 one correctly.
  ```
  {
  	"Version": "2012-10-17",
  	"Statement": [
  		{
  			"Effect": "Allow",
  			"Principal": {
  				"Service": [
  				    "s3.amazonaws.com",
  				    "ec2.amazonaws.com",
  				    "backup.amazonaws.com"
  				]
  			},
  			"Action": "sts:AssumeRole"
  		}
  	]
  }
  ```
- Now once you copy files into madireddyanil bucket
  ![984](https://github.com/user-attachments/assets/371c106a-fc3f-46ad-aced-9bd3ba13c464)

- Replication will happen after some time as below.
  ![985](https://github.com/user-attachments/assets/0cdbfcf9-40cd-45ec-a88c-02f131df45d7)

# Bucket POlicies
- Now our goal is to access the files over the internet but except knoe users others should not access it.
- so for that modify bucket policy to below code.
  ```
  {
      "Version": "2012-10-17",
      "Id": "S3PolicyId1",
      "Statement": [
          {
              "Sid": "IPAllow",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                  "arn:aws:s3:::arn:aws:s3:::madireddyanil",
                  "arn:aws:s3:::arn:aws:s3:::madireddyanil/*"
              ],
              "Condition": {
                  "IpAddress": {
                      "aws:SourceIp": "152.58.194.185/32"
                  }
              }
          }
      ]
  }
  ```
  ![986](https://github.com/user-attachments/assets/794550c8-38e4-48f6-8ef7-8ec68c260e91)
  ![987](https://github.com/user-attachments/assets/34c2effd-4276-4b1e-b65f-af5b2b828808)

- Now when you on your VPN it will not access it as IP Changed
  ![988](https://github.com/user-attachments/assets/65073439-56d8-48d6-a8af-d8bf8a3fda0f)

- After VPN off Our IP will restore so it give access for our IP.
  ![989](https://github.com/user-attachments/assets/76a3104e-15ab-4c79-85b7-7292ef0bbbb7)

- To copy the files from another account instance  to the another account s3
- assign a role to the instance, add that role in the s3 bucket policy like below.
  ```
  {
      "Version": "2012-10-17",
      "Id": "S3PolicyId1",
      "Statement": [
          {
              "Sid": "IPAllow",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                  "arn:aws:s3:::madireddyanil",
                  "arn:aws:s3:::madireddyanil/*"
              ],
              "Condition": {
                  "IpAddress": {
                      "aws:SourceIp": [
                          "152.58.194.185/32",
                          "34.200.252.49/32"
                      ]
                  }
              }
          },
          {
              "Effect": "Allow",
              "Principal": {
                  "AWS": "arn:aws:iam::232789740929:role/testrole"
              },
              "Action": "s3:*",
              "Resource": "arn:aws:s3:::madireddyanil/*"
          }
      ]
  }
  ```

- Update bucket policy with the above code and try copying the files to s3 bucket.
  ![990](https://github.com/user-attachments/assets/347ec295-9ab5-45bc-a520-def27067e212)
  ![991](https://github.com/user-attachments/assets/c46ae3d8-7bf1-43f8-b469-eb5253a20bea)
  ![992](https://github.com/user-attachments/assets/77e21234-5f85-4e66-8068-3b09084f3994)

  ### Command to display only file names
  ```
  ls -lrt | grep -v drwx | awk -F " " '{print $9}'
  ```
  ### Command to copy files into bucket.
  ```
  for file in $(ls -lrt | grep -v drwx | awk -F " " '{print $9}'); do
  > aws s3 cp $file s3://bucketname
  > done
  ```

  ### Process of deleting the s3 files
  ```
  mkdir hello
  cd hello
  aws s3 sync . s3://madireddyanil/ --delete
  ```

## Lifecycle Rules:
