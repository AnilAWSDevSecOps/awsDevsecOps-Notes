# Replication

## Configuring the Replication:

- create a madireddyanil-replication bucket and use this for replication
  ![968](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/968.png)
  ![969](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/969.png)
  ![970](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/970.png)

- create a madireddyanil bucket and use this for Source
  ![971](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/971.png)
  ![972](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/972.png)
  ![973](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/973.png)

- After creating two buckets
  ![974](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/974.png)

- Now in madireddyanil bucket under management
  ![975](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/975.png)

- Clcik on Replication rule button to create replication rule
  ![976](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/976.png)

- Fill in the details.

  ![977](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/977.png)
  ![978](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/978.png)
  ![979](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/979.png)
  ![980](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/980.png)
  ![981](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/981.png)
  ![982](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/982.png)
  ![983](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/983.png)
- Make sure the IAM roles which you select for replications should have below given in Roles > Trusted relationships
- make sure you add under services s3 and ec2 one correctly.
  ```
  {
  	"Version": "2012-10-17",
  	"Statement": [
  		{
  			"Effect": "Allow",
  			"Principal": {
  				"Service": [
  				    "s3.amazonaws.com",
  				    "ec2.amazonaws.com",
  				    "backup.amazonaws.com"
  				]
  			},
  			"Action": "sts:AssumeRole"
  		}
  	]
  }
  ```
- Now once you copy files into madireddyanil bucket
  ![984](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/984.png)

- Replication will happen after some time as below.
  ![985](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/985.png)

# Bucket POlicies

- Now our goal is to access the files over the internet but except knoe users others should not access it.
- so for that modify bucket policy to below code.
  ```
  {
      "Version": "2012-10-17",
      "Id": "S3PolicyId1",
      "Statement": [
          {
              "Sid": "IPAllow",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                  "arn:aws:s3:::arn:aws:s3:::madireddyanil",
                  "arn:aws:s3:::arn:aws:s3:::madireddyanil/*"
              ],
              "Condition": {
                  "IpAddress": {
                      "aws:SourceIp": "152.58.194.185/32"
                  }
              }
          }
      ]
  }
  ```
  ![986](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/986.png)
  ![987](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/987.png)

- Now when you on your VPN it will not access it as IP Changed
  ![988](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/988.png)

- After VPN off Our IP will restore so it give access for our IP.
  ![989](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/989.png)

- To copy the files from another account instance to the another account s3
- assign a role to the instance, add that role in the s3 bucket policy like below.
  ```
  {
      "Version": "2012-10-17",
      "Id": "S3PolicyId1",
      "Statement": [
          {
              "Sid": "IPAllow",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                  "arn:aws:s3:::madireddyanil",
                  "arn:aws:s3:::madireddyanil/*"
              ],
              "Condition": {
                  "IpAddress": {
                      "aws:SourceIp": [
                          "152.58.194.185/32",
                          "34.200.252.49/32"
                      ]
                  }
              }
          },
          {
              "Effect": "Allow",
              "Principal": {
                  "AWS": "arn:aws:iam::232789740929:role/testrole"
              },
              "Action": "s3:*",
              "Resource": "arn:aws:s3:::madireddyanil/*"
          }
      ]
  }
  ```

- Update bucket policy with the above code and try copying the files to s3 bucket.
  ![990](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/990.png)
  ![991](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/991.png)
  ![992](https://github.com/DevopsAllInOne/01-AWS-2024/blob/main/Notes-Images/940-1407/992.png)

  ### Command to display only file names
  ```
  ls -lrt | grep -v drwx | awk -F " " '{print $9}'
  ```
  ### Command to copy files into bucket.
  ```
  for file in $(ls -lrt | grep -v drwx | awk -F " " '{print $9}'); do
  > aws s3 cp $file s3://bucketname
  > done
  ```

  ### Process of deleting the s3 files
  ```
  mkdir hello
  cd hello
  aws s3 sync . s3://madireddyanil/ --delete
  ```

## Lifecycle Rules:
